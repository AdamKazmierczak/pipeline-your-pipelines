parameters:
  os: ''
  toolchain: ''
  toolchain_version: ''
  image_name_prefix: 'mydemo/azure-pipelines-agent'
  docker_registry: 'mydemo.azurecr.io'

variables:
  repo_docker_path: 'src/agents/docker/${{ parameters.os }}'

steps:
- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: '${{ parameters.docker_registry }}'
- task: Docker@2
  displayName: 'Building ${{ parameters.toolchain }} ${{ parameters.toolchain_version }} image'
  inputs:
    command: buildAndPush
    repository: '${{ parameters.docker_registry }}'
    dockerFile: '$( repo_docker_path )/${{ parameters.toolchain }}_${{ parameters.toolchain_version }}/Dockerfile'
    imageName: '${{ parameters.image_name_prefix }}/${{ parameters.toolchain }}-${{ parameters.toolchain_version }}'
    tags: |
      ${{ parameters.docker_registry }}/${{ parameters.image_name_prefix }}/${{ parameters.toolchain }}-${{ parameters.toolchain_version }}:${{ parameters.toolchain_version }}
      ${{ parameters.docker_registry }}/${{ parameters.image_name_prefix }}/${{ parameters.toolchain }}-${{ parameters.toolchain_version }}:src-$(Build.SourceVersion)
      ${{ parameters.docker_registry }}/${{ parameters.image_name_prefix }}/${{ parameters.toolchain }}-${{ parameters.toolchain_version }}:bld-$(Build.BuildId)
      ${{ parameters.docker_registry }}/${{ parameters.image_name_prefix }}/${{ parameters.toolchain }}-${{ parameters.toolchain_version }}:latest